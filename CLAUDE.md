# CLAUDE.md

## Development Commands

All commands use `bun`:

```sh
bun dev          # Start dev server on port 4008
bun run build    # Production build
bun run preview  # Preview production build
bun test         # Run tests (vitest)
bun run lint     # ESLint
bun run format   # Prettier
bun run check    # Prettier --write + ESLint --fix
```

## Tech Stack

- **Framework**: TanStack Start (TanStack Router + Nitro server runtime)
- **UI**: React 19, Tailwind CSS v4, shadcn/ui (base-maia style with Base UI headless primitives), Sora Variable font
- **Build**: Vite 7, TypeScript (strict mode)
- **Testing**: Vitest + Testing Library
- **Icons**: lucide-react

## Architecture

- **Routing**: File-based routing via TanStack Router — route files live in `src/routes/`
- **UI Components**: `src/components/ui/` (shadcn/ui components)
- **App Components**: `src/components/` (project-specific components)
- **Utilities**: `src/lib/utils.ts` (`cn()` class merge helper)
- **Styles**: `src/styles.css` (Tailwind v4 + CSS variables for theming)
- **Route Tree**: `src/routeTree.gen.ts` — auto-generated by TanStack Router plugin (do not edit manually)

## Design System

### Visual Identity

Soft/Organic aesthetic, dark mode primary. Warm, rounded, approachable — not cold/technical. Pastel accents on deep plum-charcoal backgrounds.

### Typography

- **Primary**: `Sora Variable` (`@fontsource-variable/sora`) — geometric sans-serif with rounded terminals
- **Code/Mono**: `Geist Mono Variable` (`@fontsource-variable/geist-mono`) — mapping paths, Monaco editors
- Headings: `font-semibold tracking-tight`
- Body/UI: Regular (400) / Medium (500)

### Color Palette

All colors use **OKLCH** format. Dark mode tokens (the primary theme):

| Role        | Token           | Description        |
| ----------- | --------------- | ------------------ |
| Background  | `--background`  | Deep plum-charcoal |
| Foreground  | `--foreground`  | Warm off-white     |
| Primary     | `--primary`     | Soft peach/coral   |
| Secondary   | `--secondary`   | Soft lavender      |
| Accent      | `--accent`      | Soft mint/teal     |
| Destructive | `--destructive` | Soft warm red      |

### Semantic Mapper Tokens

Custom tokens beyond standard shadcn, registered in `@theme inline` block in `src/styles.css`:

- `--source` (peach), `--target` (lavender), `--mapped` (rose)
- `--glass-bg`, `--glass-border` — glass-morphism surfaces
- `--connection-start`, `--connection-end` — SVG connection line gradient
- Tailwind classes: `text-source`, `bg-target/10`, `bg-glass-bg`, `border-glass-border`, etc.

### Glass-morphism Pattern

Standard recipe:

```
bg-glass-bg backdrop-blur-xl border border-glass-border shadow-lg rounded-xl
```

Used for: tree cards, mappings panel, modals, pane labels.

### Border Radius & Shapes

- Base `--radius`: `0.875rem`
- Pill shapes (`rounded-full`): tree nodes, mapping items, file badges, buttons, drag overlay
- `rounded-xl`: cards, upload areas
- `rounded-2xl`: modals

### Animations

Defined as keyframes + utility classes in `src/styles.css`:

- `animate-fade-in-up` + `animate-stagger-{1-4}` — entrance sequencing
- `animate-modal-enter` — modal/dialog entry
- `animate-mapped-glow` — mapped node state (pulsing glow)
- `flow-dash` + `dot-pulse` — SVG connection line effects

### Dark Mode

Default and only mode — `className="dark"` on `<html>`, `color-scheme: dark` meta tag. Do NOT add light mode toggles or light-mode-specific styles.

### Component Styling Patterns

- **Tree nodes**: Pill-shaped rows, pastel type icons (lavender=object, mint=array, peach=primitive, amber=xml-attr), CSS grid expand/collapse
- **Connection lines**: Peach-to-lavender SVG gradient, glow filter, animated dashes, colored endpoint dots
- **Modals**: Glass-morphism + `animate-modal-enter`, backdrop blur
- **File badges**: Pill with side-based color tint (`bg-source/10` or `bg-target/10`)
- **Upload areas**: Dashed border (`border-2 border-dashed`), hover to primary tint
- **Monaco editors**: Always use `theme="vs-dark"`

## TanStack Start Patterns

### Execution Model

- All code is **isomorphic by default** — included in both server and client bundles unless explicitly constrained
- Route loaders run on server during initial SSR, but **run on CLIENT during navigation** — never put secrets directly in loaders
- Use `createServerFn()` to guarantee server-only execution

### Server Functions (`createServerFn`)

- Import from `@tanstack/react-start`
- Default method is GET; use `{ method: 'POST' }` for mutations
- Chain `.validator()` for input validation (e.g. with Zod)
- Access handler input via `{ data }` parameter
- Call from route loaders or components

```ts
import { createServerFn } from "@tanstack/react-start"

const getItems = createServerFn().handler(async () => {
    return db.items.findMany()
})

const createItem = createServerFn({ method: "POST" })
    .validator(z.object({ name: z.string() }))
    .handler(async ({ data }) => {
        return db.items.create({ data })
    })
```

### API Routes (`server.handlers`)

- For client-side event handlers (form submits, button clicks), use API routes
- Define via `server.handlers` on a file route
- Supports GET, POST, PUT, DELETE etc.
- Return `Response.json()` for JSON responses

```ts
export const Route = createFileRoute("/api/items")({
    server: {
        handlers: {
            POST: async ({ request }) => {
                const body = await request.json()
                return Response.json(await db.items.create(body))
            },
        },
    },
})
```

### Route Data Loading

- Use `loader` option on routes to fetch data
- Call `createServerFn` wrappers from loaders for server-only data
- Access loader data in components via `Route.useLoaderData()`
- `beforeLoad` runs before loader — use for auth checks, redirects
- `validateSearch` for typed search params

```ts
export const Route = createFileRoute('/posts/$postId')({
  loader: ({ params }) => getPost({ data: params.postId }),
  component: () => {
    const post = Route.useLoaderData()
    return <h1>{post.title}</h1>
  },
})
```

### Middleware

- Create with `createMiddleware()` from `@tanstack/react-start`
- Use `.server()` method with `next` callback for the middleware chain
- Attach to routes via `server: { middleware: [...] }`
- Common patterns: auth checks, logging, request enrichment

### File Conventions

- `.functions.ts` — Export `createServerFn` wrappers (safe to import anywhere)
- `.server.ts` — Server-only code (only import inside server function handlers)
- `.ts` (no suffix) — Client-safe code (types, schemas, constants)

### Routing File Patterns

| Pattern             | Route                           |
| ------------------- | ------------------------------- |
| `index.tsx`         | `/`                             |
| `posts.$postId.tsx` | `/posts/:postId`                |
| `_layout.tsx`       | Layout wrapper (no URL segment) |
| `__root.tsx`        | Root layout (required)          |

## Key Conventions

- **Path alias**: `@/*` maps to `src/*`
- **Formatting**: No semicolons, single quotes (Prettier — see `prettier.config.js`)
- **Class merging**: Use `cn()` from `@/lib/utils` (clsx + tailwind-merge)
- **Component variants**: CVA (`class-variance-authority`) for variant props (see `button.tsx`)
- **Data attributes**: Components use `data-slot="component-name"` for identification
- **Named exports**: UI components use named exports (`export { Select, SelectTrigger, ... }`)
- **Base UI primitives**: shadcn/ui components wrap `@base-ui/react` headless primitives

## Adding UI Components

```sh
bunx shadcn add <component>
```

Config is in `components.json` — uses base-maia style, RSC disabled, stone base color, lucide icons.

**Important**: New shadcn components should be styled to match the glass-morphism / pill / warm palette conventions — do not leave them at shadcn defaults.
