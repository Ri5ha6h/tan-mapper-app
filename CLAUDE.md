# CLAUDE.md

## Development Commands

All commands use `bun`:

```sh
bun dev          # Start dev server on port 4008
bun run build    # Production build
bun run preview  # Preview production build
bun test         # Run tests (vitest)
bun run lint     # ESLint
bun run format   # Prettier
bun run check    # Prettier --write + ESLint --fix
```

## Tech Stack

- **Framework**: TanStack Start (TanStack Router + Nitro server runtime)
- **UI**: React 19, Tailwind CSS v4, shadcn/ui (base-maia style with Base UI headless primitives)
- **Build**: Vite 7, TypeScript (strict mode)
- **Testing**: Vitest + Testing Library
- **Icons**: lucide-react

## Architecture

- **Routing**: File-based routing via TanStack Router — route files live in `src/routes/`
- **UI Components**: `src/components/ui/` (shadcn/ui components)
- **App Components**: `src/components/` (project-specific components)
- **Utilities**: `src/lib/utils.ts` (`cn()` class merge helper)
- **Styles**: `src/styles.css` (Tailwind v4 + CSS variables for theming)
- **Route Tree**: `src/routeTree.gen.ts` — auto-generated by TanStack Router plugin (do not edit manually)

## TanStack Start Patterns

### Execution Model

- All code is **isomorphic by default** — included in both server and client bundles unless explicitly constrained
- Route loaders run on server during initial SSR, but **run on CLIENT during navigation** — never put secrets directly in loaders
- Use `createServerFn()` to guarantee server-only execution

### Server Functions (`createServerFn`)

- Import from `@tanstack/react-start`
- Default method is GET; use `{ method: 'POST' }` for mutations
- Chain `.validator()` for input validation (e.g. with Zod)
- Access handler input via `{ data }` parameter
- Call from route loaders or components

```ts
import { createServerFn } from "@tanstack/react-start"

const getItems = createServerFn().handler(async () => {
    return db.items.findMany()
})

const createItem = createServerFn({ method: "POST" })
    .validator(z.object({ name: z.string() }))
    .handler(async ({ data }) => {
        return db.items.create({ data })
    })
```

### API Routes (`server.handlers`)

- For client-side event handlers (form submits, button clicks), use API routes
- Define via `server.handlers` on a file route
- Supports GET, POST, PUT, DELETE etc.
- Return `Response.json()` for JSON responses

```ts
export const Route = createFileRoute("/api/items")({
    server: {
        handlers: {
            POST: async ({ request }) => {
                const body = await request.json()
                return Response.json(await db.items.create(body))
            },
        },
    },
})
```

### Route Data Loading

- Use `loader` option on routes to fetch data
- Call `createServerFn` wrappers from loaders for server-only data
- Access loader data in components via `Route.useLoaderData()`
- `beforeLoad` runs before loader — use for auth checks, redirects
- `validateSearch` for typed search params

```ts
export const Route = createFileRoute('/posts/$postId')({
  loader: ({ params }) => getPost({ data: params.postId }),
  component: () => {
    const post = Route.useLoaderData()
    return <h1>{post.title}</h1>
  },
})
```

### Middleware

- Create with `createMiddleware()` from `@tanstack/react-start`
- Use `.server()` method with `next` callback for the middleware chain
- Attach to routes via `server: { middleware: [...] }`
- Common patterns: auth checks, logging, request enrichment

### File Conventions

- `.functions.ts` — Export `createServerFn` wrappers (safe to import anywhere)
- `.server.ts` — Server-only code (only import inside server function handlers)
- `.ts` (no suffix) — Client-safe code (types, schemas, constants)

### Routing File Patterns

| Pattern             | Route                           |
| ------------------- | ------------------------------- |
| `index.tsx`         | `/`                             |
| `posts.$postId.tsx` | `/posts/:postId`                |
| `_layout.tsx`       | Layout wrapper (no URL segment) |
| `__root.tsx`        | Root layout (required)          |

## Key Conventions

- **Path alias**: `@/*` maps to `src/*`
- **Formatting**: No semicolons, single quotes (Prettier — see `prettier.config.js`)
- **Class merging**: Use `cn()` from `@/lib/utils` (clsx + tailwind-merge)
- **Component variants**: CVA (`class-variance-authority`) for variant props (see `button.tsx`)
- **Data attributes**: Components use `data-slot="component-name"` for identification
- **Named exports**: UI components use named exports (`export { Select, SelectTrigger, ... }`)
- **Base UI primitives**: shadcn/ui components wrap `@base-ui/react` headless primitives

## Adding UI Components

```sh
bunx shadcn add <component>
```

Config is in `components.json` — uses base-maia style, RSC disabled, stone base color, lucide icons.
